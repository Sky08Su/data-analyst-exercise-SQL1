-- 1. CREATE Table and import data:

CREATE TABLE countries(
country_code VARCHAR(50) NOT NULL,
country_name VARCHAR(100) NOT NULL
)

--Show countries who are listed more than once

SELECT country_code FROM continent
GROUP BY country_code
HAVING COUNT(country_code) > 1
ORDER BY country_code ASC

--For countries with no country code make them display as "N/A" and display them first in the list.
SELECT COALESCE (country_code, 'N/A') FROM continent
ORDER BY country_code DESC

--2. TOP 10 countries in GDP growth in 2012
-- CREATE a view of all_data for future usage
CREATE OR REPLACE VIEW all_data AS
SELECT pc.country_code, year, gdp_per_capita FROM per_capita as pc
LEFT JOIN countries
ON countries.country_code = pc.country_code
LEFT JOIN continent
ON countries.country_code = continent.country_code

--create 2011 and 2012 data
CREATE OR REPLACE VIEW data_2011 AS
SELECT * FROM all_data
WHERE year = 2011

CREATE OR REPLACE VIEW data_2012 AS
SELECT * FROM all_data
WHERE year = 2012

SELECT a.country_name, a.country_code, a.continent_code, 
((a.gdp_per_capita - b.gdp_per_capita)/(b.gdp_per_capita)) * 100
AS growth_percent
FROM data_2012 AS a
JOIN data_2011 AS b
ON a.country_code = b.country_code
ORDER BY growth_percent ASC
LIMIT 10

--3. continent percentage
CREATE OR REPLACE VIEW continent_percent AS
SELECT continent_code, (SUM(gdp_per_capita)/(SELECT SUM(gdp_per_capita) FROM all_data))*100 
AS percentage
FROM all_data
GROUP BY continent_code
--need to create a new table then union it with EU,NA data
CREATE TABLE rest_gdp(
region_name VARCHAR(50),
gdp_per_capita float)

INSERT INTO rest_gdp (region_name, gdp_per_capita)
VALUES(
'Rest of the World', (SELECT 100-SUM(percentage) FROM continent_percent
WHERE continent_code IN ('NA','EU'))

CREATE OR REPLACE VIEW new_continent_data AS
SELECT * FROM continent_percent
WHERE continent_code = 'NA' OR continent_code = 'EU'
UNION 
SELECT * FROM rest_gdp

--To PIVOT
SELECT 
	max(percentage) filter (WHERE continent_code = 'NA') AS NA,
	max(percentage) filter (WHERE continent_code = 'EU') AS EU,
	max(percentage) filter (WHERE continent_code = 'Rest of the World') AS rest_of_the_world
FROM new_continent_data

--4. AVG gdp per year per continent
SELECT year, continent_code, 
ROUND((Sum(gdp_per_capita)/COUNT(country_name))::numeric,2) AS average_GDP
FROM all_data
GROUP BY year, continent_code
HAVING continent_code IS NOT NULL
ORDER BY year

--5. median (percentile) gdp per year per continent
SELECT year, continent_code, 
PERCENTILE_COUNT(0.5) WITHIN GROUP(ORDER BY gdp_per_capita) AS median_GDP
FROM all_data
GROUP BY year, continent_code
HAVING continent_code IS NOT NULL
AND year BETWEEN 2004 AND 2012
ORDER BY year
